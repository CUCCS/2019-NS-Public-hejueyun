# iptableså®éªŒ

# å®éªŒç›®çš„

* äº†è§£å’Œç†Ÿæ‚‰iptablesè§„åˆ™

# å®éªŒç¯å¢ƒ

* å‡å®šå¦‚ä¸‹å±€åŸŸç½‘æ‹“ï¼š
  
  ```
  +----------------------+          +-------------------------+       +----------------------+     
  |     host-1           |          |   host-2                |       |     host-3           |  
  |     172.16.18.11     |          |   eth0:0 172.16.18.1    |       |     172.16.18.12     |  
  |                      |          |   eth0: 192.168.1.123   |       |                      |  
  +-------------+--------+          +----------+--------------+       +-------------+--------+  
                |                              |                                    |
                |                              |                                    |
       +--------+------------------------------+--+                                 |
       |                äº¤æ¢æœº                    |---------------------------------+
       +-----------------+------------------------+
                         |
                         |
                   +-----+-----------+
                   |   eth0          |   `
                   |   192.168.1.1   |
                +--+-----------------+---------+
                |                              |
                |        host-gw / dns-svr     |
                |                              |
                +------------------+----------++
                                   |  eth1    |
                                   +----------+
  ```
  
  * host-1ä¸Šé…ç½®äº†é»˜è®¤ç½‘å…³æŒ‡å‘ IP åœ°å€ï¼š172.16.18.1ï¼ŒåŸŸåè§£ææœåŠ¡å™¨é…ç½®ä¸º IPï¼š192.168.1.1
  * host-3ä¸Šé…ç½®äº†é»˜è®¤ç½‘å…³æŒ‡å‘ IP åœ°å€ï¼š172.16.18.1ï¼ŒåŸŸåè§£ææœåŠ¡å™¨é…ç½®ä¸º IPï¼š192.168.1.1

# å®éªŒåŸç†

**Temporary virtual network interfaceï¼ˆä¸´æ—¶è™šæ‹Ÿç½‘å¡ï¼‰**

```shell
$ifconfig eth0:0
eth0:0    Link encap:Ethernet  HWaddr 3c:97:0e:02:98:c8  
          UP BROADCAST MULTICAST  MTU:1500  Metric:1
          Interrupt:20 Memory:f1600000-f1620000 

$ifconfig eth0:0 123.123.22.22
$ifconfig eth0:0
eth0:0    Link encap:Ethernet  HWaddr 3c:97:0e:02:98:c8  
          inet addr:123.123.22.22  Bcast:123.255.255.255  Mask:255.0.0.0
$ping 123.123.22.22
PING 123.123.22.22 (123.123.22.22) 56(84) bytes of data.
64 bytes from 123.123.22.22: icmp_req=1 ttl=64 time=0.060 ms
64 bytes from 123.123.22.22: icmp_req=2 ttl=64 time=0.057 ms
```

**iptables**

* ç»“æ„

  * `Table`>`Chain`>`Rule`

    <img src="./img/struct.png" style="height:300px">

* è¡¨ä¸å†…å»ºé“¾

  * Filterè¡¨ï¼ˆé»˜è®¤è¡¨ï¼‰
    * **INPUTé“¾** â€“ å½“ç»è¿‡è·¯ç”±åˆ¤æ–­åï¼Œè¦è¿›å…¥æœ¬æœºçš„æ•°æ®åŒ…æ‰§è¡Œçš„è§„åˆ™
    * **OUTPUTé“¾** â€“ ç”±æœ¬æœºäº§ç”Ÿï¼Œéœ€å‘å¤–å‘çš„æ•°æ®åŒ…æ‰§è¡Œçš„è§„åˆ™
    * **FORWARDé“¾** â€“ ç›®çš„åœ°ä¸æ˜¯æœ¬æœºï¼Œå¹¶éœ€è¦å°†å…¶**è·¯ç”±**åˆ°æœ€ç»ˆåœ°å€æˆ–ä¸‹ä¸€è·³çš„æ•°æ®åŒ…æ‰§è¡Œçš„è§„åˆ™
  * NATè¡¨
    * **PREROUTINGé“¾** â€“ å¤„ç†åˆšåˆ°è¾¾æœ¬æœºå¹¶åœ¨è·¯ç”±è½¬å‘å‰çš„æ•°æ®åŒ…ã€‚å®ƒä¼šè½¬æ¢æ•°æ®åŒ…ä¸­çš„ç›®æ ‡IPåœ°å€ï¼Œé€šå¸¸ç”¨äºDNAT(destination NAT)
      * ç³»ç»Ÿæ˜¯å…ˆè¿›å…¥ DNATï¼Œç„¶åæ‰è¿›å…¥è·¯ç”±åŠè¿‡è™‘ç­‰æ“ä½œ
      * ä¿å­˜ç¿»è¯‘çš„æ˜ å°„å…³ç³»åˆ°å†…å­˜
    * **POSTROUTINGé“¾** â€“ å¤„ç†å³å°†ç¦»å¼€æœ¬æœºçš„æ•°æ®åŒ…ã€‚å®ƒä¼šè½¬æ¢æ•°æ®åŒ…ä¸­çš„æºIPåœ°å€ï¼Œé€šå¸¸ç”¨äºSNAT(source NAT)
      * éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç³»ç»Ÿåœ¨è·¯ç”±åŠè¿‡è™‘ç­‰å¤„ç†ç›´åˆ°æ•°æ®åŒ…è¦è¢«é€å‡ºæ—¶æ‰è¿›å…¥ SNAT
      * ä¿å­˜ç¿»è¯‘çš„æ˜ å°„å…³ç³»åˆ°å†…å­˜
    * **OUTPUTé“¾** â€“ å¤„ç†æœ¬æœºäº§ç”Ÿçš„æ•°æ®åŒ…
  * Mangleè¡¨
  * Rawè¡¨

* è§„åˆ™

  * æ ¼å¼ï¼š`iptables [-t è¡¨] å‘½ä»¤ åŒ¹é… åŠ¨ä½œ`
  
  * å‘½ä»¤
  
    | å‘½ä»¤                      | è¯´æ˜                               |
    | :------------------------ | :--------------------------------- |
    | -Pæˆ–--policy <é“¾å>       | å®šä¹‰é»˜è®¤ç­–ç•¥                       |
    | -Læˆ–--list <é“¾å>         | æŸ¥çœ‹iptablesè§„åˆ™åˆ—è¡¨               |
    | -Aæˆ–--append <é“¾å>       | åœ¨è§„åˆ™åˆ—è¡¨çš„æœ€åå¢åŠ 1æ¡è§„åˆ™        |
    | -Iæˆ–--insert <é“¾å>       | åœ¨æŒ‡å®šçš„ä½ç½®æ’å…¥1æ¡è§„åˆ™            |
    | -Dæˆ–--delete <é“¾å>       | ä»è§„åˆ™åˆ—è¡¨ä¸­åˆ é™¤1æ¡è§„åˆ™            |
    | -Ræˆ–--replace <é“¾å>      | æ›¿æ¢è§„åˆ™åˆ—è¡¨ä¸­çš„æŸæ¡è§„åˆ™           |
    | -Fæˆ–--flush <é“¾å>        | åˆ é™¤è§„åˆ™åˆ—è¡¨ä¸­æ‰€æœ‰è§„åˆ™             |
    | -Zæˆ–--zero <é“¾å>         | å°†è¡¨ä¸­æ•°æ®åŒ…è®¡æ•°å™¨å’Œæµé‡è®¡æ•°å™¨å½’é›¶ |
    | -Xæˆ–--delete-chain <é“¾å> | åˆ é™¤ç©ºçš„è§„åˆ™åˆ—è¡¨                   |
    | -Næˆ–--new-chain <é“¾å>    | æ–°å»ºè§„åˆ™åˆ—è¡¨                       |
  
    * `-F`ä¸`-X`åŒºåˆ«
  
      ```
      -F
      +---------------+       +---------------+
      |               |       |               |
      | Chain MyChain |       | Chain MyChain |
      |     Rule 1    |  -F   |      is       |
      |     Rule 2    |       |     empty     |
      |     Rule 3    |  ==>  |               |
      |               |       |               |
      +---------------+       +---------------+
      -X
      +---------------+
      |               |
      | Chain MyChain |         Chain MyChain
      |      is       |  -X      does not exist
      |     empty     |
      |               |  ==>
      |               |
      +---------------+
      ```
  
  * åŒ¹é…
  
    | åŒ¹é…                | è¯´æ˜                                                         |
    | :------------------ | :----------------------------------------------------------- |
    | -i<ç½‘ç»œæ¥å£å>      | æŒ‡å®šæ•°æ®åŒ…ä»å“ªä¸ªç½‘ç»œæ¥å£è¿›å…¥ï¼Œå¦‚ppp0ã€eth0å’Œeth1ç­‰           |
    | -o<ç½‘ç»œæ¥å£å>      | æŒ‡å®šæ•°æ®åŒ…ä»å“ªå—ç½‘ç»œæ¥å£è¾“å‡ºï¼Œå¦‚ppp0ã€eth0å’Œeth1ç­‰           |
    | -p<åè®®ç±»å‹>        | æŒ‡å®šæ•°æ®åŒ…åŒ¹é…çš„åè®®ï¼Œå¦‚TCPã€UDPå’ŒICMPç­‰ï¼Œé»˜è®¤ä¸ºall          |
    | -s<æºåœ°å€æˆ–å­ç½‘>    | æŒ‡å®šæ•°æ®åŒ…åŒ¹é…çš„æºåœ°å€                                       |
    | --sport <æºç«¯å£å·>  | æŒ‡å®šæ•°æ®åŒ…åŒ¹é…çš„æºç«¯å£å·ï¼Œå¯ä»¥ä½¿ç”¨â€œèµ·å§‹ç«¯å£å·:ç»“æŸç«¯å£å·â€çš„æ ¼å¼æŒ‡å®šä¸€ä¸ªèŒƒå›´çš„ç«¯å£ |
    | -d<ç›®æ ‡åœ°å€æˆ–å­ç½‘>  | æŒ‡å®šæ•°æ®åŒ…åŒ¹é…çš„ç›®æ ‡åœ°å€                                     |
    | --dport<ç›®æ ‡ç«¯å£å·> | æŒ‡å®šæ•°æ®åŒ…åŒ¹é…çš„ç›®æ ‡ç«¯å£å·ï¼Œå¯ä»¥ä½¿ç”¨â€œèµ·å§‹ç«¯å£å·:ç»“æŸç«¯å£å·â€çš„æ ¼å¼æŒ‡å®šä¸€ä¸ªèŒƒå›´çš„ç«¯å£ |
    | -j                  | å†³å®šå½“ä¸è§„åˆ™åŒ¹é…æ—¶å¦‚ä½•å¤„ç†æ•°æ®åŒ…                             |
    | -m state            | å¯ç”¨çŠ¶æ€åŒ¹é…æ¨¡å—                                             |
    | -â€“tcp-flags         | (**é’ˆå¯¹-p tcp**)å¯ä»¥æŒ‡å®šç”±é€—å·åˆ†éš”çš„å¤šä¸ªå‚æ•°ï¼Œæœ‰æ•ˆå€¼å¯ä»¥æ˜¯ï¼šSYN, ACK, FIN, RST, URG, PSH |
    | â€“-state             | çŠ¶æ€åŒ¹é…æ¨¡å—çš„å‚æ•°ã€‚NEWã€ESTABLISHEDã€RELATED                |
  
    > * **NEW** meaning that the packet has started a new connection, or otherwise associated with a connection which has not seen packets in both directions
    > * **ESTABLISHED** meaning that the packet is associated with a connection which has seen packets in both directions
    > * **RELATED** meaning that the packet is starting a new connection, but is associated with an existing connection, such as an FTP data transfer, or an ICMP error
    > * **INVALID** meaning that the packet could not be identified for some reason which includes running out of memory and ICMP errors which don't correspond to any known connection
  
  * åŠ¨ä½œ
  
    | åŠ¨ä½œ       | è¯´æ˜                                                         |
    | :--------- | :----------------------------------------------------------- |
    | **åŸºæœ¬**   |                                                              |
    | ACCEPT     | æ¥å—æ•°æ®åŒ…                                                   |
    | DROP       | ä¸¢å¼ƒæ•°æ®åŒ…                                                   |
    | QUEUE      | å°†æ•°æ®åŒ…ç§»äº¤åˆ°ç”¨æˆ·ç©ºé—´                                       |
    | RETURN     | åœæ­¢æ‰§è¡Œå½“å‰é“¾ä¸­çš„åç»­Rulesï¼Œå¹¶è¿”å›åˆ°è°ƒç”¨é“¾(the calling chain)ä¸­ |
    | **æ‹“å±•**   |                                                              |
    | REDIRECT   | å°†æ•°æ®åŒ…é‡æ–°è½¬å‘åˆ°æœ¬æœºæˆ–å¦ä¸€å°ä¸»æœºçš„æŸä¸ªç«¯å£ï¼Œé€šå¸¸ç”¨åŠŸèƒ½å®ç°é€æ˜ä»£ç†æˆ–å¯¹å¤–å¼€æ”¾å†…ç½‘æŸäº›æœåŠ¡ |
    | SNAT       | æºåœ°å€è½¬æ¢ï¼Œå³æ”¹å˜æ•°æ®åŒ…çš„æºåœ°å€                             |
    | DNAT       | ç›®æ ‡åœ°å€è½¬æ¢ï¼Œå³æ”¹å˜æ•°æ®åŒ…çš„ç›®çš„åœ°å€                         |
    | MASQUERADE | IPä¼ªè£…ï¼Œå³æ˜¯å¸¸è¯´çš„NATæŠ€æœ¯ï¼ŒMASQUERADEåªèƒ½ç”¨äºADSLç­‰æ‹¨å·ä¸Šç½‘çš„IPä¼ªè£…ï¼Œä¹Ÿå°±æ˜¯ä¸»æœºçš„IPæ˜¯ç”±ISPåˆ†é…åŠ¨æ€çš„ï¼›å¦‚æœä¸»æœºçš„IPåœ°å€æ˜¯é™æ€å›ºå®šçš„ï¼Œå°±è¦ä½¿ç”¨SNAT |
    | LOG        | æ—¥å¿—åŠŸèƒ½ï¼Œå°†ç¬¦åˆè§„åˆ™çš„æ•°æ®åŒ…çš„ç›¸å…³ä¿¡æ¯è®°å½•åœ¨æ—¥å¿—ä¸­ï¼Œä»¥ä¾¿ç®¡ç†å‘˜çš„åˆ†æå’Œæ’é”™ |
  
  * **RETURN**
  
    > é¡¾åæ€ä¹‰ï¼Œå®ƒä½¿åŒ…è¿”å›ä¸Šä¸€å±‚ï¼Œé¡ºåºæ˜¯ï¼šå­é“¾â€”â€”>çˆ¶é“¾â€”â€”>ç¼ºçœçš„ç­–ç•¥ã€‚å…·ä½“åœ°è¯´ï¼Œå°±æ˜¯è‹¥åŒ…åœ¨å­é“¾ ä¸­é‡åˆ°äº†RETURNï¼Œåˆ™è¿”å›çˆ¶é“¾çš„ä¸‹ä¸€æ¡è§„åˆ™ç»§ç»­è¿›è¡Œæ¡ä»¶çš„æ¯”è¾ƒï¼Œè‹¥æ˜¯åœ¨çˆ¶é“¾ï¼ˆæˆ–ç§°ä¸»é“¾ï¼Œæ¯”å¦‚INPUTï¼‰ä¸­ é‡åˆ°äº†RETURNï¼Œå°±è¦è¢«ç¼ºçœçš„ç­–ç•¥ï¼ˆä¸€èˆ¬æ˜¯ACCEPTæˆ–DROPï¼‰æ“ä½œäº†
  
  * **SNAT**
  
    > æ¯”å¦‚ï¼Œå¤šä¸ªPCæœºä½¿ç”¨ADSLè·¯ç”±å™¨å…±äº«ä¸Šç½‘ï¼Œæ¯ä¸ªPCæœºéƒ½é…ç½®äº†å†…ç½‘IPã€‚PCæœºè®¿é—®å¤–éƒ¨ç½‘ç»œçš„æ—¶å€™ï¼Œè·¯ç”±å™¨å°†æ•°æ®åŒ…çš„æŠ¥å¤´ä¸­çš„æºåœ°å€æ›¿æ¢æˆè·¯ç”±å™¨çš„ipï¼Œå½“å¤–éƒ¨ç½‘ç»œçš„æœåŠ¡å™¨æ¯”å¦‚ç½‘ç«™webæœåŠ¡å™¨æ¥åˆ°è®¿é—®è¯·æ±‚çš„æ—¶å€™ï¼Œä»–çš„æ—¥å¿—è®°å½•ä¸‹æ¥çš„æ˜¯è·¯ç”±å™¨çš„ipåœ°å€ï¼Œè€Œä¸æ˜¯pcæœºçš„å†…ç½‘ipã€‚è¿™æ˜¯å› ä¸ºï¼Œè¿™ä¸ªæœåŠ¡å™¨æ”¶åˆ°çš„æ•°æ®åŒ…çš„æŠ¥å¤´é‡Œè¾¹çš„â€œæºåœ°å€â€ï¼Œå·²ç»è¢«æ›¿æ¢äº†ã€‚
  
  * **DNAT**
  
    > å…¸å‹çš„åº”ç”¨æ˜¯ï¼Œæœ‰ä¸ªwebæœåŠ¡å™¨æ”¾åœ¨å†…ç½‘é…ç½®å†…ç½‘ipï¼Œå‰ç«¯æœ‰ä¸ªé˜²ç«å¢™é…ç½®å…¬ç½‘ipã€‚äº’è”ç½‘ä¸Šçš„è®¿é—®è€…ä½¿ç”¨å…¬ç½‘ipæ¥è®¿é—®è¿™ä¸ªç½‘ç«™ã€‚å½“è®¿é—®çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯å‘å‡ºä¸€ä¸ªæ•°æ®åŒ…ï¼Œè¿™ä¸ªæ•°æ®åŒ…çš„æŠ¥å¤´é‡Œè¾¹ï¼Œç›®æ ‡åœ°å€å†™çš„æ˜¯é˜²ç«å¢™çš„å…¬ç½‘ipã€‚é˜²ç«å¢™ä¼šæŠŠè¿™ä¸ªæ•°æ®åŒ…çš„æŠ¥å¤´æ”¹å†™ä¸€æ¬¡ï¼Œå°†ç›®æ ‡åœ°å€æ”¹å†™æˆwebæœåŠ¡å™¨çš„å†…ç½‘ipï¼Œç„¶åå†æŠŠè¿™ä¸ªæ•°æ®åŒ…å‘é€åˆ°å†…ç½‘çš„webæœåŠ¡å™¨ä¸Šã€‚è¿™æ ·ï¼Œæ•°æ®åŒ…å°±ç©¿é€äº†é˜²ç«å¢™ï¼Œå¹¶ä»å…¬ç½‘ipå˜æˆäº†ä¸€ä¸ªå¯¹å†…ç½‘åœ°å€çš„è®¿é—®äº†
  
  * **MASQUERADE**
  
    > åœ°å€ä¼ªè£…ï¼Œåœ¨iptablesä¸­æœ‰ç€å’ŒSNATç›¸è¿‘çš„æ•ˆæœï¼Œä½†ä¹Ÿæœ‰ä¸€äº›åŒºåˆ«:
    >
    > * ç”¨SNATçš„æ—¶å€™ï¼Œå‡ºå£ipçš„åœ°å€èŒƒå›´å¯ä»¥æ˜¯ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ª
    >
    >   ```sh
    >   iptables -t nat -A POSTROUTING -s 10.8.0.0/255.255.255.0 -o eth0 -j SNAT --to-source 192.168.5.3-192.168.5.5
    >   ```
    >
    > * å¦‚ä¸ŠğŸ‘†å‘½ä»¤è¡¨ç¤ºæŠŠæ‰€æœ‰10.8.0.0ç½‘æ®µçš„æ•°æ®åŒ…SNATæˆ192.168.5.3/192.168.5.4/192.168.5.5ç­‰å‡ ä¸ªipç„¶åå‘å‡ºå»ã€‚ä½†æ˜¯ï¼Œå¯¹äºSNATï¼Œä¸ç®¡æ˜¯å‡ ä¸ªåœ°å€ï¼Œå¿…é¡»æ˜ç¡®çš„æŒ‡å®šè¦SNATçš„ipï¼ˆè€Œè¿™å¯èƒ½ä¼šåŠ¨æ€å˜åŒ–ï¼‰
    >
    > * MASQUERADEå°±æ˜¯é’ˆå¯¹è¿™ç§åœºæ™¯è€Œè®¾è®¡çš„ï¼Œä»–çš„ä½œç”¨æ˜¯ï¼Œä»æœåŠ¡å™¨çš„ç½‘å¡ä¸Šï¼Œè‡ªåŠ¨è·å–å½“å‰ipåœ°å€æ¥åšNAT
  
* **æŸ¥çœ‹ç‰¹å®šè¡¨çš„è§„åˆ™**ï¼š`iptables -t <table> --list`

* **é»˜è®¤ç­–ç•¥å®šä¹‰**ï¼š`iptables [-t è¡¨å] <-P é»˜è®¤ç­–ç•¥> <é“¾å> <åŠ¨ä½œ>`

  * å½“æ•°æ®åŒ…ä¸å±äºé“¾ä¸­ä»»ä½•è§„åˆ™æ—¶ï¼Œiptableså°†æ ¹æ®è¯¥é“¾é¢„å…ˆå®šä¹‰çš„é»˜è®¤ç­–ç•¥å¤„ç†æ•°æ®åŒ…

* 0.0.0.0/0

  > åœ¨è·¯ç”±å™¨é…ç½®ä¸­å¯ç”¨0.0.0.0/0è¡¨ç¤ºé»˜è®¤è·¯ç”±ï¼Œä½œç”¨æ˜¯å¸®åŠ©è·¯ç”±å™¨å‘é€è·¯ç”±è¡¨ä¸­æ— æ³•æŸ¥è¯¢çš„åŒ…ã€‚å¦‚æœè®¾ç½®äº†å…¨é›¶ç½‘ç»œçš„è·¯ç”±ï¼Œè·¯ç”±è¡¨ä¸­æ— æ³•æŸ¥è¯¢çš„åŒ…éƒ½å°†é€åˆ°å…¨é›¶ç½‘ç»œçš„è·¯ç”±ä¸­å»ã€‚ä¸¥æ ¼è¯´æ¥ï¼Œ0.0.0.0å·²ç»ä¸æ˜¯ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šçš„IPåœ°å€äº†ã€‚å®ƒè¡¨ç¤ºçš„æ˜¯è¿™æ ·ä¸€ä¸ªé›†åˆï¼šæ‰€æœ‰æœªçŸ¥çš„ä¸»æœºå’Œç›®çš„ç½‘ç»œã€‚
  > è¿™é‡Œçš„â€œæœªçŸ¥â€æ˜¯æŒ‡åœ¨æœ¬æœºçš„è·¯ç”±è¡¨é‡Œæ²¡æœ‰ç‰¹å®šæ¡ç›®æŒ‡æ˜å¦‚ä½•åˆ°è¾¾

# å®éªŒå†…å®¹

## è§£é‡Šhost-2 ä¸Šçš„ iptables é…ç½®è„šæœ¬

```sh
#!/bin/bash

IPT="/sbin/iptables"

$IPT --flush
# æ¸…ç©ºæ‰€æœ‰é“¾ä¸­æ‰€æœ‰è§„åˆ™
$IPT --delete-chain
# åˆ é™¤æ‰€æœ‰ç©ºé“¾

$IPT -P INPUT DROP
# INPUTé“¾é»˜è®¤DROPè§„åˆ™ï¼Œå³é»˜è®¤ä¸¢åŒ…
$IPT -P FORWARD DROP
# FORWARDè§„åˆ™DROPè§„åˆ™ï¼Œå³é»˜è®¤ä¸¢åŒ…
$IPT -P OUTPUT ACCEPT
# OUTPUTé“¾é»˜è®¤ACCEPTè§„åˆ™ï¼Œå³é»˜è®¤è¾“å‡º

$IPT -N forward_demo
# æ–°å»ºforward_demoé“¾
$IPT -N icmp_demo
# æ–°å»ºicmp_demoé“¾

$IPT -A INPUT -i lo -j ACCEPT
# å…è®¸å›ç¯ç½‘å¡æ•°æ®è¾“å…¥
$IPT -A OUTPUT -o lo -j ACCEPT
# å…è®¸å›ç¯ç½‘å¡æ•°æ®è¾“å‡º

$IPT -A INPUT -p tcp ! --syn -m state --state NEW -s 0.0.0.0/0 -j DROP
# ä¸¢å¼ƒæ‰€æœ‰ä¸åŒ…å«SYNçš„ã€å»ºç«‹TCPè¯·æ±‚çš„åŒ…
$IPT -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
# æ¥æ”¶æ‰€æœ‰å…¥ç«™TCPæ•°æ®åŒ…
$IPT -A INPUT -p icmp -j icmp_demo
# å¯¹ICMPåŒ…æ¥æ”¶ï¼Œè·³è½¬åˆ°icmp_demoé“¾ä¸Šè§„åˆ™å¤„ç†

$IPT -A icmp_demo -p icmp -i eth0 -j ACCEPT
# æ¥æ”¶eth0è¿›å…¥çš„icmpåŒ…
$IPT -A icmp_demo -j RETURN
# ä»å­é“¾ï¼ˆå½“å‰icmp_demoé“¾ï¼‰è¿”å›çˆ¶é“¾ï¼ˆè°ƒç”¨é“¾ï¼‰ï¼Œå³ä¸¢åŒ…

$IPT -A FORWARD -j forward_demo
# forward_demoå¤„ç†è·¯ç”±è½¬å‘

$IPT -A forward_demo -j LOG --log-prefix FORWARD_DEMO
# æŠŠforward_demoé“¾çš„æ—¥å¿—è®°å½•åˆ°å‘½åå‰ç¼€ä¸ºFORWARD_DEMOçš„æ—¥å¿—
$IPT -A forward_demo -p tcp --dport 80 -m string --algo bm --string 'baidu' -j DROP
# ç¦æ­¢è½¬å‘URLé‡Œæœ‰â€˜baiduâ€™çš„tcpåŒ…
$IPT -A forward_demo -p tcp -s 172.16.18.11 -j ACCEPT
# è½¬å‘æ¥è‡ªhost-1çš„tcpåŒ…
$IPT -A forward_demo -p tcp -d 172.16.18.11 -j ACCEPT
# è½¬å‘å‰å¾€host-1çš„tcpåŒ…
$IPT -A forward_demo -p udp -s 172.16.18.11 --dport 53 -j ACCEPT
# è½¬å‘æ¥è‡ªhost-1çš„udpåŒ…
$IPT -A forward_demo -p udp -s 172.16.18.1  --dport 53 -j ACCEPT
#  è½¬å‘æ¥è‡ªhost-2çš„udpåŒ…
$IPT -A forward_demo -p udp -s 192.168.1.1  --sport 53 -j ACCEPT
#  è½¬å‘æ¥è‡ªhost-gwçš„udpåŒ…
$IPT -A forward_demo -p tcp -s 192.168.1.1 -j ACCEPT
# è½¬å‘è‡ªhost-gwçš„çš„tcpåŒ… 
$IPT -A forward_demo -s 172.16.18.1 -j RETURN
# å¯¹æ¥è‡ªhost-2çš„æ•°æ®åŒ…ï¼Œè½¬çˆ¶é“¾å¤„ç†ï¼Œå³ä¸¢åŒ…
$IPT -t nat -A POSTROUTING -s 172.16.18.1/24 -o eth0 -j MASQUERADE
# å¯¹172.16.18.1/24ç½‘æ®µçš„æ•°æ®åŒ…ï¼ŒåŠ¨æ€è¯»å–eth0çš„ipåšSNATç„¶åè¾“å‡º
```

## æ€è€ƒ

**1. host-1å¯ä»¥pingé€šip: 172.16.18.1å—?**

* å¯ä»¥

> æ ¹æ®`$IPT -A icmp_demo -p icmp -i eth0 -j ACCEPT`ï¼Œæ¥æ”¶eth0è¿›å…¥çš„icmpåŒ…ï¼›åŒæ—¶æ³¨æ„åˆ°hsot-2é…ç½®äº†è™šæ‹Ÿç½‘å¡eth0:0ï¼Œæ•…host-2æ¥æ”¶æ¥è‡ªhost-1çš„`echo requset`ï¼›è€Œæ ¹æ®`$IPT -P OUTPUT ACCEPT`ï¼Œhost-2å°†è¿”å›`echo reply`ï¼Œæ•…å¯ä»¥pingé€š

**2. host-1å¯ä»¥pingé€šip: 192.168.1.1å—ï¼Ÿ**

* å¯ä»¥

> å› ä¸ºhost-2å¼host-1çš„é»˜è®¤ç½‘å…³ï¼Œæ‰€ä»¥æºå¸¦icmpçš„ä»¥å¤ªç½‘å¸§ä¼šå…ˆåˆ°è¾¾host-2ã€‚åŒ1é¢˜ï¼Œhost-2æ¥æ”¶æ¥è‡ªhost-1çš„icmpåŒ…ï¼Œè€Œæ­¤æ—¶**æºåœ°å€**éœ€è¦ä»172.16.18.x/24è·¯ç”±è½¬åˆ°192.168.1.x/24(**SNAT**)ï¼Œæ ¹æ®`$IPT -t nat -A POSTROUTING -s 172.16.18.1/24 -o eth0 -j MASQUERADE`ï¼Œåšäº†ipè½¬æ¢åè¾“å‡ºï¼Œæœ€ç»ˆåˆ°è¾¾host-gw.
>
> å‡è®¾host-gwæ¥æ”¶`echo request`ï¼Œè¿”å›`echo reply`ï¼Œhost-2å°†å°†ç›®çš„åœ°å€åšDNATï¼ˆ**è¿™ä¸æ˜¯ä¾èµ–äºiptablesçš„è§„åˆ™ï¼Œè€Œæ˜¯ä¾èµ–äºä¹‹å‰å†…å­˜ä¿å­˜çš„ç¿»è¯‘çš„æ˜ å°„å…³ç³»ï¼Œåè¿‡æ¥ä½¿ç”¨**ï¼‰ï¼Œå¹¶æœ€ç»ˆé€è¾¾host-1

**3. host-1å¯ä»¥pingé€šåŸŸå:www.baidu.comå—ï¼Ÿ**

* ä¸å¯ä»¥

> * `$IPT -A forward_demo -p tcp --dport 80 -m string --algo bm --string 'baidu' -j DROP`ï¼Œ`host-2`ç¦æ­¢è½¬å‘URLé‡Œæœ‰â€˜baiduâ€™çš„åŒ…ï¼Œè€Œ`host-1`çš„é»˜è®¤ç½‘å…³æ˜¯`host-2`ï¼Œéœ€è¦ç»ç”±`host-2`è½¬å‘åˆ°`dns-svr`ï¼Œæ•…æ— æ³•pingé€š
>

**4. host-1å¯ä»¥è®¿é—®:http://61.135.169.121 å—ï¼Ÿ**

* å¯ä»¥

> host-1å‘é€ä»¥å¤ªç½‘å¸§åˆ°host-2ï¼Œhost-2åšåŠ¨æ€ipè½¬æ¢å†å‘ç»™host-gwï¼Œhost-gwåšnatå‘é€æœ€ç»ˆçš„`http get`
>
> host-gwå‘é€`http response`åˆ°host-2ï¼Œhost-2åšDNATï¼Œè¿”å›ç»™host-1

**5. host-3å¯ä»¥pingé€šip: 172.16.18.1å—ï¼Ÿ**

* å¯ä»¥

> åŸå› è§1

**6. host-3å¯ä»¥pingé€šip: 192.168.1.1å—ï¼Ÿ**

* å¯ä»¥

> åŸå› è§2

**7. host-3å¯ä»¥è®¿é—®äº’è”ç½‘å—ï¼Ÿ**

* åŸºæœ¬å¯ä»¥

> é™¤äº†URLå¸¦â€˜baiduâ€™çš„

# å‚è€ƒèµ„æ–™

[iptablesè¯¦ç»†æ•™ç¨‹ï¼šåŸºç¡€ã€æ¶æ„ã€æ¸…ç©ºè§„åˆ™ã€è¿½åŠ è§„åˆ™ã€åº”ç”¨å®ä¾‹ - Lesca æŠ€æœ¯å®…](http://lesca.me/archives/iptables-tutorial-structures-configuratios-examples.html)

[linux - Delete a iptables chain with its all rules - Server Fault](https://serverfault.com/questions/375981/delete-a-iptables-chain-with-its-all-rules)

[What is the difference between iptables -X and iptables -F? - Server Fault](https://serverfault.com/questions/656091/what-is-the-difference-between-iptables-x-and-iptables-f)

[IPåœ°å€ 0.0.0.0 æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ - xiluhua - åšå®¢å›­](https://www.cnblogs.com/xiluhua/p/10657917.html)

[iptables(8) - Linux man page ï¼ˆ**Recommend**ï¼‰](https://linux.die.net/man/8/iptables)

[iptablesä¹‹FORWARDè½¬å‘é“¾  -Linux_woniu-51CTOåšå®¢](https://blog.51cto.com/linuxcgi/1965296)

[IPtablesä¸­SNATå’ŒMASQUERADEçš„åŒºåˆ«-æ“ä½œç³»ç»Ÿ- (**Recommend**)](http://server.zhiding.cn/server/2008/0317/772069.shtml)

[Configuring virtual network interfaces in Linux - LinuxConfig.org](https://linuxconfig.org/configuring-virtual-network-interfaces-in-linux)

[Forward Ping reques - LinuxQuestions.org (**Recommend**)](https://www.linuxquestions.org/questions/linux-security-4/forward-ping-request-4175615657/)